using System;
using System.Threading;
using System.Threading.Tasks;
using OpenQA.Selenium;
using RE.Core.Extensions;
using RE.Core.Interfaces.Services;
using WDSE;
using WDSE.Decorators;
using WDSE.ScreenshotMaker;

namespace RE.Infrastructure.Services
{
    public class WebDriverScreenShotService : IWebshotService
    {
        private readonly IWebDriver _webDriver;

        public WebDriverScreenShotService(IWebDriver webDriver)
        {
            _webDriver = webDriver;
        }

        public async Task<byte[]> TakeShot(Uri uri, CancellationToken cancellationToken)
        {
            _webDriver.Url = uri.ToString();

            await Task.Delay(500, cancellationToken);
            HideObstructiveElements();
            await Task.Delay(500, cancellationToken);

            var vcd = new VerticalCombineDecorator(new ScreenshotMaker().RemoveScrollBarsWhileShooting());
            var imageArray = _webDriver.TakeScreenshot(vcd);

            return imageArray;
        }

        private void HideObstructiveElements()
        {
            var olxConsentScreen = _webDriver.LocateElement(By.Id("onetrust-consent-sdk"));
            _webDriver.HideElement(olxConsentScreen);

            var casaAlbaConsentScreen = _webDriver.LocateElement(By.ClassName("cookies-consent"));
            _webDriver.HideElement(casaAlbaConsentScreen);

            var interImobiliareChat = _webDriver.LocateElement(By.Id("fb-root"));
            _webDriver.HideElement(interImobiliareChat);

            if (_webDriver.Url.StartsWith("https://expert-casa.ro/"))
            {
                _webDriver.Navigate().Refresh();
                var expertCasaConsentScreen = _webDriver.LocateElement(By.ClassName("alert-cookies-backdrop"));
                _webDriver.HideElement(expertCasaConsentScreen);
            }
        }

        public void Dispose()
        {
            _webDriver?.Quit();
            _webDriver?.Dispose();
        }
    }
}